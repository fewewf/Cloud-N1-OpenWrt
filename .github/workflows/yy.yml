name: Cloud N1 deep

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 0'  # 每周日北京时间下午4点 (UTC+8)

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FILES: N1/files
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build_openwrt:
    name: Build OpenWrt and release
    runs-on: ubuntu-latest

    steps:
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        swap-storage: true

    - name: Checkout
      uses: actions/checkout@v3.1.0
      with:
        path: ${{ github.workspace }}/N1

    - name: Initialization environment
      env:
        DEBIAN_FRONTID: noninteractive
      run: |
        
        sudo add-apt-repository universe  # 添加 Universe 仓库
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
        g++-multilib gettext git libncurses-dev libssl-dev python3-dev python3-lib2to3 rsync unzip \
        zlib1g-dev u-boot-tools

    - name: Clone source code
      run: |
        git clone --depth 1 --branch $REPO_BRANCH $REPO_URL lede
        cd lede
        git config --global http.postBuffer 524288000  # 解决 feeds 下载超时‌:ml-citation{ref="3" data="citationList"}

    - name: Copy N1 configuration files
      run: |
        cp -rf ${{ env.FILES }}/* lede/
        chmod +x lede/script.sh
        chmod +x lede/config.sh

    - name: Compile OpenWrt
      run: |
        cd lede
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig
        ./config.sh  # 应用 N1 适配配置‌:ml-citation{ref="1,2" data="citationList"}
        make -j$(nproc) download
        make -j$(($(nproc)+1)) V=s

    - name: Upload to Releases
      uses: softprops/action-gh-release@v1
      with:
        files: lede/bin/targets/*/*/*.img.gz
        tag_name: latest
        body: "Cloud-N1-OpenWrt 自动编译固件 (内核版本: ${{ env.KERNEL_VERSION }})"
      if: github.ref == 'refs/heads/main' && env.UPLOAD_FIRMWARE == 'true'
